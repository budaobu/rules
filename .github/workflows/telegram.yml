# .github/workflows/fetch-telegram-asn.yml
name: Fetch ASN Telegram List

on:
  schedule:
    - cron: '8 19 * * 1'  # ÊØèÂë®‰∏Ä 19:08 UTC
  push:
    branches:
      - main
    paths:
      - 'py/telegram-asn-scraper.py'
      - '.github/workflows/fetch-telegram-asn.yml'
  workflow_dispatch:

jobs:
  fetch_asn_telegram_list:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp beautifulsoup4 lxml

      - name: Run Telegram ASN scraper
        run: |
          python py/telegram-asn-scraper.py
        continue-on-error: false

      - name: Validate output
        run: |
          if [ ! -f "lists/telegram.list" ]; then
            echo "‚ùå Output file not generated"
            exit 1
          fi
          
          line_count=$(wc -l < lists/telegram.list)
          if [ "$line_count" -lt 30 ]; then
            echo "‚ö†Ô∏è  Warning: Output file has only $line_count lines (expected >30)"
            exit 1
          fi
          
          # Ê£ÄÊü•ÂøÖË¶ÅÁöÑÂüüÂêçËßÑÂàô
          if ! grep -q "DOMAIN-SUFFIX,t.me" lists/telegram.list; then
            echo "‚ùå Missing required domain rules"
            exit 1
          fi
          
          echo "‚úì Output file validated: $line_count lines"

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code lists/telegram.list || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            ü§ñ Update Telegram ASN list
            
            Auto-generated by GitHub Actions
            Run ID: ${{ github.run_id }}
          file_pattern: 'lists/telegram.list data/telegram/history/*.json'
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: telegram-asn-failure-logs
          path: |
            lists/
            data/
          retention-days: 7
