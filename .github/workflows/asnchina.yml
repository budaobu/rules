# .github/workflows/fetch-cn-asn.yml
name: Fetch ASN China List

on:
  schedule:
    - cron: '23 18 * * 2'  # æ¯å‘¨äºŒ 18:23 UTC
  push:
    branches:
      - main
    paths:
      - 'py/cn-asn-scraper.py'
      - '.github/workflows/fetch-cn-asn.yml'
  workflow_dispatch:

jobs:
  fetch_asn_china_list:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºå˜æ›´æ£€æµ‹

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright aiohttp beautifulsoup4 lxml
          playwright install chromium --with-deps

      - name: Run China ASN scraper
        run: |
          python py/cn-asn-scraper.py
        continue-on-error: false

      - name: Validate output
        run: |
          if [ ! -f "lists/cn_asn.list" ]; then
            echo "âŒ Output file not generated"
            exit 1
          fi
          
          line_count=$(wc -l < lists/cn_asn.list)
          if [ "$line_count" -lt 100 ]; then
            echo "âš ï¸  Warning: Output file has only $line_count lines (expected >100)"
            exit 1
          fi
          
          echo "âœ“ Output file validated: $line_count lines"

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code lists/cn_asn.list || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            ğŸ¤– Update China ASN list
            
            Auto-generated by GitHub Actions
            Run ID: ${{ github.run_id }}
          file_pattern: 'lists/cn_asn.list data/history/*.json'
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cn-asn-failure-logs
          path: |
            lists/
            data/
          retention-days: 7
